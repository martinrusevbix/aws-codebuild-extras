#!/bin/sh

export CI=true
export CODEBUILDEXTRA=true

export CODEBUILDEXTRA_ACCOUNT_ID=$(aws sts get-caller-identity --query 'Account' --output text)

export CODEBUILDEXTRA_GIT_BRANCH="$(git symbolic-ref HEAD --short 2>/dev/null)"
if [ "$CODEBUILDEXTRA_GIT_BRANCH" = "" ] ; then
  export CODEBUILDEXTRA_GIT_BRANCH="$(git rev-parse HEAD | xargs git name-rev | cut -d' ' -f2 | sed 's/remotes\/origin\///g')";
fi

export CODEBUILDEXTRA_GIT_CLEAN_BRANCH="$(echo $CODEBUILDEXTRA_GIT_BRANCH | tr '/' '.')"
export CODEBUILDEXTRA_GIT_ESCAPED_BRANCH="$(echo $CODEBUILDEXTRA_GIT_CLEAN_BRANCH | sed -e 's/[]\/$*.^[]/\\\\&/g')"
export CODEBUILDEXTRA_GIT_MESSAGE="$(git log -1 --pretty=%B)"
export CODEBUILDEXTRA_GIT_AUTHOR="$(git log -1 --pretty=%an)"
export CODEBUILDEXTRA_GIT_AUTHOR_EMAIL="$(git log -1 --pretty=%ae)"
export CODEBUILDEXTRA_GIT_COMMIT="$(git log -1 --pretty=%H)"
export CODEBUILDEXTRA_GIT_SHORT_COMMIT="$(git log -1 --pretty=%h)"
export CODEBUILDEXTRA_GIT_TAG="$(git describe --tags --exact-match 2>/dev/null)"
export CODEBUILDEXTRA_GIT_MOST_RECENT_TAG="$(git describe --tags --abbrev=0)"

export CODEBUILDEXTRA_PULL_REQUEST=false
if [ "${CODEBUILDEXTRA_GIT_BRANCH#pr-}" != "$CODEBUILDEXTRA_GIT_BRANCH" ] ; then
  export CODEBUILDEXTRA_PULL_REQUEST=${CODEBUILDEXTRA_GIT_BRANCH#pr-};
fi

export CODEBUILDEXTRA_PROJECT=${CODEBUILDEXTRA_BUILD_ID%:$CODEBUILDEXTRA_LOG_PATH}

echo "==> AWS CODEBUILDEXTRA Extra Environment Variables:"
echo "==> CI = $CI"
echo "==> CODEBUILDEXTRA = $CODEBUILDEXTRA"
echo "==> CODEBUILDEXTRA_ACCOUNT_ID = $CODEBUILDEXTRA_ACCOUNT_ID"
echo "==> CODEBUILDEXTRA_GIT_AUTHOR = $CODEBUILDEXTRA_GIT_AUTHOR"
echo "==> CODEBUILDEXTRA_GIT_AUTHOR_EMAIL = $CODEBUILDEXTRA_GIT_AUTHOR_EMAIL"
echo "==> CODEBUILDEXTRA_GIT_BRANCH = $CODEBUILDEXTRA_GIT_BRANCH"
echo "==> CODEBUILDEXTRA_GIT_CLEAN_BRANCH = $CODEBUILDEXTRA_GIT_CLEAN_BRANCH"
echo "==> CODEBUILDEXTRA_GIT_ESCAPED_BRANCH = $CODEBUILDEXTRA_GIT_ESCAPED_BRANCH"
echo "==> CODEBUILDEXTRA_GIT_COMMIT = $CODEBUILDEXTRA_GIT_COMMIT"
echo "==> CODEBUILDEXTRA_GIT_SHORT_COMMIT = $CODEBUILDEXTRA_GIT_SHORT_COMMIT"
echo "==> CODEBUILDEXTRA_GIT_MESSAGE = $CODEBUILDEXTRA_GIT_MESSAGE"
echo "==> CODEBUILDEXTRA_GIT_TAG = $CODEBUILDEXTRA_GIT_TAG"
echo "==> CODEBUILDEXTRA_GIT_MOST_RECENT_TAG = $CODEBUILDEXTRA_GIT_MOST_RECENT_TAG"
echo "==> CODEBUILDEXTRA_PROJECT = $CODEBUILDEXTRA_PROJECT"
echo "==> CODEBUILDEXTRA_PULL_REQUEST = $CODEBUILDEXTRA_PULL_REQUEST"
